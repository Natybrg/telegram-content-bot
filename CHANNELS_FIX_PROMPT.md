# פרומפט לתיקון מערכת ניהול ערוצי טלגרם

## הקשר כללי

פרויקט זה הוא בוט טלגרם שמעבד תוכן (תמונות, אודיו, וידאו) ושולח אותו לערוצי טלגרם ולקבוצות וואטסאפ. המערכת משתמשת ב-Pyrogram לניהול ערוצים ושליחת תוכן.

### מידע טכני חשוב על Pyrogram ו-peer_id

1. **peer_id ב-Pyrogram:**
   - Pyrogram משתמש ב-`peer_id` שהוא bytes object שמזהה ערוץ/קבוצה/משתמש
   - `peer_id` הוא יציב יותר מ-ID רגיל (מספר) כי הוא לא משתנה
   - ניתן להמיר `peer_id` ל-Base64 string לשמירה ב-JSON (`peer_id_b64`)

2. **יצירת peer_id:**
   - הדרך הכי אמינה: `resolve_peer(channel_id)` מחזיר `InputPeerChannel` עם `channel_id` ו-`access_hash`
   - ניתן לבנות `peer_id` bytes מ-`channel_id` ו-`access_hash` (struct.pack)
   - `get_chat(channel_id)` מחזיר Chat object עם `peer_id` attribute (אם קיים)

3. **שימוש ב-peer_id:**
   - Pyrogram יכול לקבל גם `peer_id` (bytes) וגם `chat_id` (int/str) ב-`send_message`, `send_photo`, וכו'
   - אבל `peer_id` הוא יותר אמין, במיוחד לערוצים פרטיים

4. **המבנה הנוכחי:**
   - הערוצים נשמרים ב-`channels.json` כ-dicts עם `peer_id_b64` (Base64 string), `title`, ו-`legacy_id` (ID רגיל)
   - `peer_id_b64` הוא הערך העיקרי לזיהוי ערוץ
   - `legacy_id` נשמר רק לתאימות לאחור

## בעיות עיקריות שזוהו

### 1. הוספת ערוצי טלגרם - קוד מורכב מדי עם fallbacks רבים

**מיקום:** `plugins/settings/channels.py`, פונקציה `handle_forwarded_channel_message` (שורות 232-576)

**בעיות:**
- הקוד מנסה ליצור `peer_id_b64` בכמה דרכים שונות (dialogs, get_chat, send_message, resolve_peer)
- יש הרבה fallbacks וקוד כפול
- לוגיקה מורכבת מדי שקשה לתחזק
- בדיקות רבות שיכולות להוביל לבלבול
- אם נכשלת יצירת `peer_id_b64`, הקוד עדיין מנסה לשמור עם ID רגיל, מה שיוצר חוסר עקביות

**מה צריך:**
- פשט את הלוגיקה ליצירת `peer_id_b64`
- שיטה אחת ברורה ומועדפת ליצירת `peer_id_b64`
- אם נכשלת יצירת `peer_id_b64`, לא לשמור את הערוץ (או לשמור עם סימון ברור שהוא לא תקין)
- הודעות שגיאה ברורות למשתמש

### 2. שמירת ערוצים - תמיכה בפורמטים ישנים וחדשים

**מיקום:** `services/channels/storage.py` ו-`services/channels/manager.py`

**בעיות:**
- תמיכה בפורמט ישן (strings) ופורמט חדש (dicts עם `peer_id_b64`)
- קוד מיגרציה חלקי שיכול להוביל לבעיות
- בדיקות כפילות אם ערוץ כבר קיים (לפי `peer_id_b64`, `legacy_id`, וכו')
- בלבול בין `peer_id_b64` ל-`legacy_id`

**מה צריך:**
- פורמט אחיד אחד - dict עם `peer_id_b64` (חובה), `title` (חובה), `legacy_id` (אופציונלי)
- הסרת תמיכה בפורמט ישן (strings) - מיגרציה חד-פעמית של כל הערכים הישנים
- בדיקה אחת פשוטה אם ערוץ קיים (לפי `peer_id_b64` בלבד)
- אם אין `peer_id_b64`, לא לשמור את הערוץ

### 3. שליחה לערוצים - קוד מורכב עם fallbacks רבים

**מיקום:** `services/channels/sender.py`, פונקציה `send_to_telegram_channels` (שורות 50-371)

**בעיות:**
- פונקציה `decode_peer_id` מנסה לטפל גם ב-ID רגיל וגם ב-`peer_id_b64`
- הרבה fallbacks - אם נכשל עם `peer_id_b64`, מנסה עם `legacy_id`, ואז עם `resolve_peer`, וכו'
- קוד כפול - אותו לוגיקה חוזרת על עצמה
- אם נכשלת שליחה לערוץ, הקוד מנסה עוד הרבה דברים במקום לתת שגיאה ברורה

**מה צריך:**
- שימוש עקבי ב-`peer_id_b64` בלבד (או `legacy_id` אם אין `peer_id_b64`)
- fallback אחד פשוט: אם נכשל עם `peer_id_b64`, ננסה עם `legacy_id` (אם קיים)
- אם גם זה נכשל, נחזיר שגיאה ברורה
- הסרת קוד כפול

### 4. שימוש בערוצים - אי-עקביות

**מיקום:** `services/content/orchestrator.py` ו-`services/delivery/telegram_delivery.py`

**בעיות:**
- הקוד משתמש ב-`get_template_channels` שמחזיר רשימת `peer_id_b64`
- אבל לא תמיד ברור אם זה `peer_id_b64` או `legacy_id`
- אין בדיקה שהערוצים תקינים לפני שליחה

**מה צריך:**
- שימוש עקבי ב-`peer_id_b64` בלבד
- בדיקה שהערוצים תקינים לפני שליחה (או לפחות טיפול בשגיאות ברור)

## מה צריך לעשות - תוכנית תיקון

### שלב 1: פשט את שמירת הערוצים

1. **עדכן את `ChannelsStorage`:**
   - הסר תמיכה בפורמט ישן (strings) - רק dicts עם `peer_id_b64` (חובה), `title` (חובה), `legacy_id` (אופציונלי)
   - פשט את `add_to_repository` - בדיקה אחת אם ערוץ קיים (לפי `peer_id_b64` בלבד)
   - הסר את `_migrate_old_format` - במקום זה, צור סקריפט מיגרציה חד-פעמי

2. **עדכן את `ChannelsManager`:**
   - הסר תמיכה בפורמט ישן
   - פשט את `is_in_repository` - רק חיפוש לפי `peer_id_b64`
   - וודא שכל הפונקציות מחזירות/מקבלות `peer_id_b64` בלבד

3. **צור סקריפט מיגרציה:**
   - סקריפט שיריץ פעם אחת וימיר כל ערוץ ישן (string או dict ללא `peer_id_b64`) לפורמט החדש
   - אם לא ניתן ליצור `peer_id_b64` לערוץ ישן, יש לסמן אותו כלא תקין או להסיר אותו

### שלב 2: פשט את הוספת הערוצים

1. **עדכן את `handle_forwarded_channel_message`:**
   - שיטה אחת ברורה ליצירת `peer_id_b64`: `resolve_peer` (הכי אמין)
   - אם `resolve_peer` נכשל, ננסה `get_chat` ואז נבנה `peer_id_b64` מ-`channel_id` ו-`access_hash`
   - אם גם זה נכשל, לא נשמור את הערוץ (או נשמור עם סימון שהוא לא תקין)
   - הסר את כל ה-fallbacks המיותרים

2. **וידוא תקינות:**
   - לפני שמירה, נבדוק שניתן לשלוח הודעה לערוץ (אופציונלי, אבל מומלץ)
   - אם לא ניתן לשלוח, לא נשמור את הערוץ

### שלב 3: פשט את שליחת התוכן

1. **עדכן את `send_to_telegram_channels`:**
   - פשט את `decode_peer_id` - אם זה `peer_id_b64` (Base64), נפענח אותו. אחרת, נשתמש בו כ-ID רגיל
   - fallback אחד: אם נכשל עם `peer_id_b64`, ננסה עם `legacy_id` (אם קיים במאגר)
   - אם גם זה נכשל, נחזיר שגיאה ברורה
   - הסר קוד כפול

2. **וידוא עקביות:**
   - כל הקוד שמשתמש בערוצים צריך להשתמש ב-`peer_id_b64` בלבד
   - אם אין `peer_id_b64`, נשתמש ב-`legacy_id` (אם קיים)

### שלב 4: בדיקות ואימות

1. **בדוק שהכל עובד:**
   - הוספת ערוץ חדש
   - הסרת ערוץ
   - שליחה לערוץ אחד
   - שליחה למספר ערוצים
   - טיפול בשגיאות (ערוץ לא קיים, לא ניתן לשלוח, וכו')

2. **וידוא תאימות לאחור:**
   - אם יש ערוצים ישנים במאגר, המיגרציה צריכה לעבוד
   - אם אין `peer_id_b64`, נשתמש ב-`legacy_id` (אבל נסה ליצור `peer_id_b64` בפעם הבאה)

## קבצים שצריך לערוך

1. **`services/channels/storage.py`**
   - הסר תמיכה בפורמט ישן
   - פשט את `add_to_repository` ו-`remove_from_repository`
   - הסר את `_migrate_old_format`

2. **`services/channels/manager.py`**
   - הסר תמיכה בפורמט ישן
   - פשט את `is_in_repository` ופונקציות אחרות

3. **`plugins/settings/channels.py`**
   - פשט את `handle_forwarded_channel_message`
   - הסר fallbacks מיותרים
   - וידוא תקינות לפני שמירה

4. **`services/channels/sender.py`**
   - פשט את `decode_peer_id`
   - פשט את `send_to_telegram_channels`
   - הסר קוד כפול

5. **`services/content/orchestrator.py` ו-`services/delivery/telegram_delivery.py`**
   - וידוא שימוש עקבי ב-`peer_id_b64`
   - טיפול בשגיאות ברור

## עקרונות חשובים

1. **פשטות:** קוד פשוט יותר = קל יותר לתחזק ולתקן
2. **עקביות:** פורמט אחד אחיד לכל הערוצים
3. **שגיאות ברורות:** אם משהו נכשל, נחזיר שגיאה ברורה במקום לנסות עוד הרבה דברים
4. **תאימות לאחור:** אם יש ערוצים ישנים, המיגרציה צריכה לעבוד (אבל לא לתמוך בפורמט ישן לנצח)

## תוצאה צפויה

לאחר התיקון:
- הוספת ערוץ תהיה פשוטה וברורה
- שמירת ערוצים תהיה עקבית (רק פורמט אחד)
- שליחה לערוצים תהיה מהירה ואמינה
- שגיאות יהיו ברורות וניתנות לטיפול
- הקוד יהיה קל יותר לתחזק ולהבין

## הערות נוספות

- הקפד על לוגים ברורים בכל שלב
- בדוק שהכל עובד עם ערוצים קיימים במאגר
- אם יש ערוצים ישנים, המיגרציה צריכה לעבוד אוטומטית
- וודא שהכל עובד גם עם userbot וגם עם bot רגיל
